


<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gabungan Penjana Rujukan NOC & Penganalisis Projek v8.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* --- GENERAL --- */
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        
        /* --- INPUTS --- */
        .input-label { display: block; font-size: 0.7rem; font-weight: 700; color: #6b7280; margin-bottom: 0.1rem; text-transform: uppercase; }
        .std-input { width: 100%; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; transition: border-color 0.15s; }
        .std-select { width: 100%; padding: 0.3rem; border: 1px solid #9ca3af; border-radius: 0.375rem; font-size: 0.8rem; background-color: #f3f4f6; margin-bottom: 4px; }
        .std-input:focus, .std-select:focus { border-color: #4f46e5; outline: none; ring: 2px solid #e0e7ff; }
        
        /* --- TABLES (ON SCREEN PREVIEW) --- */
        .excel-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-family: 'Arial', sans-serif; 
            font-size: 10pt; 
            color: black; 
            border: 1px solid black; 
            background: white; 
            line-height: 1.0;
        }
        .excel-table th { 
            border: 1px solid black; 
            background-color: #f0f0f0; 
            font-weight: bold; 
            text-align: center; 
            padding: 2px 4px;
            vertical-align: middle;
        }
        .excel-table td { 
            border: 1px solid black; 
            padding: 2px 4px; 
            text-align: left; 
            vertical-align: top; 
            height: auto;
        }
        .excel-table td.center-col { text-align: center; }
        .excel-table td.money-col { text-align: right; white-space: nowrap; font-weight: bold; }
        .excel-table tr.highlight-row { background-color: #fffbeb; font-weight: bold; }
        
        /* --- MASTER MEMO --- */
        #masterMemoContainer {
            background-color: white; border: 1px solid #ccc; padding: 50px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: 'Arial', sans-serif; 
            font-size: 11pt; 
            line-height: 1.0; 
            color: black; margin-top: 20px;
            text-align: justify;
        }

        /* --- SPACING FIXES --- */
        #masterMemoContainer p { margin-bottom: 1em; margin-top: 0; }
        #masterMemoContainer p:last-child { margin-bottom: 0; }
        #master-noc, #master-condensed, #master-breakdown, #master-manual-text { margin-bottom: 20px; }
        .table-container { margin-bottom: 20px; }

        /* --- OTHER --- */
        #nocInput { font-family: monospace; font-size: 10pt; }
        .diff-increase { color: #dc2626; font-weight: bold; }
        .diff-decrease { color: #16a34a; font-weight: bold; }
        .percentage-tag { font-size: 0.85em; color: #000; font-weight: 800; margin-left: 4px; }
        
        @media print {
            body * { visibility: hidden; }
            #masterMemoContainer, #masterMemoContainer * { visibility: visible; }
            #masterMemoContainer { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; border: none; box-shadow: none; }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-200">
        
        <div class="mb-8 pb-4 border-b flex flex-wrap gap-4 justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Papan Pemuka Analisis Projek</h1>
                <p class="text-sm text-gray-500">Versi 8.8 (Clean Output - Word Only)</p>
            </div>
            <div class="flex gap-2">
                <button onclick="saveData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-2 shadow">üíæ Simpan Data</button>
                <button onclick="document.getElementById('fileInput').click()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-2 shadow">üìÇ Muat Naik</button>
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="loadData(this)">
                <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-2 shadow">üîÑ Reset</button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="lg:border-r lg:pr-6 border-gray-200">
                <h2 class="text-xl font-bold text-blue-700 mb-3">1. Penjana Ayat Rujukan NOC</h2>
                <p class="text-xs text-gray-500 mb-2">Tampal Tajuk & Data Mentah:</p>
                <textarea id="nocInput" class="std-input h-48 mb-2" placeholder="Tampal data di sini..." oninput="handleNocInput()"></textarea>
                <div id="noc-output-storage" class="hidden"></div>
                <div class="bg-blue-50 p-3 rounded border border-blue-200 text-sm text-blue-800">
                    <strong>Status:</strong> <span id="noc-status">Menunggu input...</span>
                </div>
            </div>
            
            <div class="lg:pl-2">
                <h2 class="text-xl font-bold text-indigo-700 mb-3">2. Penganalisis & Editor Data</h2>
                <p class="text-xs text-gray-500 mb-2">Tampal Teks Projek untuk pengisian automatik:</p>
                
                <textarea id="inputText" class="std-input h-32 mb-4 border-indigo-300 focus:border-indigo-500" 
                          placeholder="Tampal perenggan projek di sini..." oninput="parseTextToInputs()"></textarea>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-300 space-y-3">
                    
                    <div>
                        <label class="input-label">Nama Projek</label>
                        <input type="text" id="inp_projectName" class="std-input font-bold">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="input-label">Kod Projek (P)</label><input type="text" id="inp_codeP" class="std-input"></div>
                        <div><label class="input-label">Maklumat Kelulusan</label><input type="text" id="inp_approvalInfo" class="std-input font-bold text-blue-800"></div>
                    </div>

                    <hr class="border-gray-300">

                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="input-label text-indigo-700">Kos Asal [A]</label>
                            <select id="sel_costA" class="std-select" onchange="syncSelectToInput('sel_costA', 'inp_costA')"></select>
                            <input type="text" id="inp_costA" class="std-input text-right" placeholder="0.00">
                        </div>
                        <div>
                            <label class="input-label text-green-700">Penambahan</label>
                            <select id="sel_costAdd" class="std-select" onchange="syncSelectToInput('sel_costAdd', 'inp_costAdd')"></select>
                            <input type="text" id="inp_costAdd" class="std-input text-right" placeholder="0.00">
                        </div>
                        <div>
                            <label class="input-label text-red-700">Kos Baharu (Rev)</label>
                            <select id="sel_costRev" class="std-select" onchange="syncSelectToInput('sel_costRev', 'inp_costRev')"></select>
                            <input type="text" id="inp_costRev" class="std-input text-right" placeholder="0.00">
                        </div>
                    </div>

                    <hr class="border-gray-300">

                    <div>
                        <label class="input-label text-gray-700 bg-yellow-100 inline-block px-1">Ulasan/Ayat Tambahan (Manual)</label>
                        <textarea id="inp_manualText" class="std-input h-24" placeholder="Taip ulasan tambahan di sini..."></textarea>
                    </div>

                    <hr class="border-gray-300">

                    <div class="grid grid-cols-1 gap-2">
                        <div class="flex gap-2 items-end">
                            <div class="w-7/12"><label class="input-label">Label Item [B]</label><input type="text" id="inp_labelB" class="std-input" value="Kos PDA Asal [B]"></div>
                            <div class="w-5/12"><label class="input-label">Jumlah [B]</label><select id="sel_valB" class="std-select" onchange="syncSelectToInput('sel_valB', 'inp_valB')"></select><input type="text" id="inp_valB" class="std-input text-right"></div>
                        </div>
                        <div class="flex gap-2 items-end">
                            <div class="w-7/12"><label class="input-label">Label Item [D]</label><input type="text" id="inp_labelD" class="std-input" value="Kos PDA Pindaan [D]"></div>
                            <div class="w-5/12"><label class="input-label">Jumlah [D]</label><select id="sel_valD" class="std-select" onchange="syncSelectToInput('sel_valD', 'inp_valD')"></select><input type="text" id="inp_valD" class="std-input text-right"></div>
                        </div>
                    </div>

                    <button onclick="generateOutputs()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded shadow mt-4">
                        KEMASKINI DATA & JANA MEMO
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-12 border-t-4 border-gray-800 pt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-900">MEMO LENGKAP (GABUNGAN)</h2>
                <div>
                    <button onclick="downloadWord()" class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2">
                        üíæ Muat Turun Word (.doc)
                    </button>
                </div>
            </div>

            <div id="masterMemoContainer">
                <div id="master-noc" class="mb-8 text-black text-justify"><span class="text-gray-400 italic">[Rujukan NOC akan muncul di sini...]</span></div>
                
                <div id="master-condensed" class="table-container"></div>

                <div id="master-breakdown" class="table-container"></div>

                <div id="master-manual-text" class="mb-8 text-justify text-black"></div>

                <div id="master-closing" class="text-justify text-black"></div>
            </div>
        </div>

    </div>

    <script>
        // --- UTILS ---
        const getNum = (str) => { if (!str) return 0; let s = str.toString().replace(/(RM| |\,)/g, ''); return parseFloat(s) || 0; };
        const fmtMoney = (num) => { if (isNaN(num)) return "0.00"; return "RM" + num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); };
        const safeExtract = (text, regex, idx=1) => { let m = text.match(regex); return (m && m[idx]) ? m[idx].trim() : ""; };

        // --- EXTRACTORS ---
        function smartExtractApprovalInfo(text) {
            let clean = text.replace(/\n/g, ' ');
            let complexMatch = clean.match(/Rolling Plan\s+([\w-]+).*?(Tahun\s+\d{4})?.*?(\(RP\d+.*?\))/i);
            if (complexMatch) return `Rolling Plan ${complexMatch[1]}${complexMatch[2]?" "+complexMatch[2]:""} ${complexMatch[3]}`;
            let yearMatch = clean.match(/Rolling Plan\s+[\w-]+\s+Tahun\s+\d{4}/i);
            if (yearMatch) return yearMatch[0];
            let simpleMatch = clean.match(/Rolling Plan\s+[\w-]+/i);
            if (simpleMatch) return simpleMatch[0];
            return "RP (Sila isi manual)";
        }

        function smartExtractProjectName(text) {
            let cleanText = text.replace(/\n/g, ' ');
            const states = ["JOHOR", "KEDAH", "KELANTAN", "MELAKA", "NEGERI SEMBILAN", "PAHANG", "PERAK", "PERLIS", "PULAU PINANG", "SABAH", "SARAWAK", "SELANGOR", "TERENGGANU", "WILAYAH PERSEKUTUAN", "KUALA LUMPUR", "LABUAN", "PUTRAJAYA", "MALAYSIA"];
            const starts = ["PROJEK", "PROGRAM", "CADANGAN", "MEMBINA", "NAIKTARAF", "NAIK TARAF", "PENYELENGGARAAN", "PEROLEHAN", "KERJA-KERJA", "KAJIAN", "PEMBINAAN", "MENAIKTARAF"];
            const stateRegex = new RegExp(`\\b(${starts.join('|')})\\b.{5,200}?\\b(${states.join('|')})\\b`, 'i');
            if (cleanText.match(stateRegex)) return cleanText.match(stateRegex)[0].replace(/\s+/g, ' ').replace(/[.,:;]+$/, '').trim();
            const generalRegex = new RegExp(`\\b(${starts.join('|')})\\b(?:\\s+\\S+){1,16}`, 'i');
            const generalMatch = cleanText.match(generalRegex);
            if (generalMatch) {
                let potentialTitle = generalMatch[0];
                [" DENGAN KOS", " YANG", " BAGI", " DI BAWAH", " MERUPAKAN", " UNTUK", " BERNILAI", " BERJUMLAH", " TELAH"].forEach(p => {
                    const idx = potentialTitle.toUpperCase().indexOf(p);
                    if (idx > -1) potentialTitle = potentialTitle.substring(0, idx);
                });
                return potentialTitle.replace(/[.,:;]+$/, '').trim();
            }
            const pCodeMatch = text.match(/(?:P[\d]{14}\s+-\s+)(.*?)(?:\s+PERKARA\s+|Sila)/i);
            if(pCodeMatch) return pCodeMatch[1].trim();
            return "";
        }

        // --- Contextual Cost Scanner ---
        function scanContextualCosts(text) {
            const matches = [...text.matchAll(/(?:RM\s*)?([\d,]+(?:\.\d{2})?(?:\s*(?:juta|million|mil|j))?)/ig)];
            const validCosts = new Set();
            matches.forEach(match => {
                const fullMatch = match[0]; const valStr = match[1]; const index = match.index;
                let cleanVal = valStr.trim().replace(/(juta|million|mil|j)/i, '');
                let isMil = valStr.match(/(juta|million|mil|j)/i);
                let num = parseFloat(cleanVal.replace(/,/g, ''));
                let isYear = (num >= 1990 && num <= 2035 && !valStr.includes('.'));
                if (isYear && !fullMatch.toUpperCase().includes("RM")) {
                    const strictLookback = text.substring(Math.max(0, index - 15), index).toLowerCase();
                    if (!strictLookback.includes("kos")) return;
                }
                if (num < 500 && !fullMatch.toUpperCase().includes("RM")) return;
                const lookbackText = text.substring(Math.max(0, index - 60), index).toLowerCase();
                const keywords = ["kos", "cost", "harga", "price", "nilai", "value", "jumlah", "total", "sebanyak", "berjumlah", "siling", "peruntukan", "rmke", "rp", "rolling", "perbelanjaan", "belanja", "kontrak", "contract"];
                const hasKeyword = keywords.some(k => lookbackText.includes(k));
                if (fullMatch.toUpperCase().includes("RM") || hasKeyword) {
                    if(isMil) num = num * 1000000;
                    validCosts.add(fmtMoney(num));
                }
            });
            return Array.from(validCosts).sort((a,b) => getNum(b) - getNum(a));
        }

        function fillDropdown(selectId, costs) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- Pilih Auto --</option>';
            costs.forEach(c => { let opt = document.createElement('option'); opt.value = c; opt.text = c; select.add(opt); });
        }
        function syncSelectToInput(selectId, inputId) {
            const val = document.getElementById(selectId).value;
            if(val) document.getElementById(inputId).value = val;
        }

        // --- 1. PARSING LOGIC ---
        function parseTextToInputs() {
            const text = document.getElementById('inputText').value;
            if (!text.trim()) return;

            let pName = smartExtractProjectName(text);
            if(pName) document.getElementById('inp_projectName').value = pName;
            document.getElementById('inp_codeP').value = safeExtract(text, /\(P[\d]{14}\)/i, 0).replace(/[()]/g,'');
            document.getElementById('inp_approvalInfo').value = smartExtractApprovalInfo(text);

            const filteredCosts = scanContextualCosts(text);
            ['sel_costA', 'sel_costAdd', 'sel_costRev', 'sel_valB', 'sel_valD'].forEach(id => fillDropdown(id, filteredCosts));

            let smartCostA = safeExtract(text, /(?:Rolling\s+Plan|RMKe|diluluskan|projek\s+sambungan)[\s\S]{1,200}?(?:dengan\s+kos|kos\s+sebanyak|kos\s+berjumlah|kos\s+keseluruhan|kos\s+asal)(?:.*?)RM?\s*([\d,]+(?:\.\d{2})?)/i, 1);
            if (!smartCostA) smartCostA = safeExtract(text, /(?:kos asal|kos yang diluluskan|kos berjumlah).*?RM?([\d,]+\.\d{2})/i, 1);
            let rawAdd = safeExtract(text, /(?:peningkatan|tambahan).*?RM?([\d,]+\.\d{2})/i, 1);
            let rawRev = safeExtract(text, /(?:kos baharu|kos dipinda|meningkat kepada).*?RM?([\d,]+\.\d{2})/i, 1);
            
            if(smartCostA) document.getElementById('inp_costA').value = "RM" + smartCostA;
            if(rawAdd) document.getElementById('inp_costAdd').value = "RM" + rawAdd;
            if(rawRev) document.getElementById('inp_costRev').value = "RM" + rawRev;

            let matchB = text.match(/(\d+\.\s+)?(.*?)\s*\[B\]\s*RM?\s*([\d,]+\.\d{2})/i);
            if(matchB) { document.getElementById('inp_labelB').value = matchB[2].trim() + " [B]"; document.getElementById('inp_valB').value = "RM" + matchB[3]; }
            let matchD = text.match(/(\d+\.\s+)?(.*?)\s*\[D\]\s*RM?\s*([\d,]+\.\d{2})/i);
            if(matchD) { document.getElementById('inp_labelD').value = matchD[2].trim() + " [D]"; document.getElementById('inp_valD').value = "RM" + matchD[3]; }

            let valA = getNum(document.getElementById('inp_costA').value);
            let valAdd = getNum(document.getElementById('inp_costAdd').value);
            let valRev = getNum(document.getElementById('inp_costRev').value);
            if(valA > 0 && valAdd !== 0 && valRev === 0) {
                document.getElementById('inp_costRev').value = fmtMoney(valA + valAdd);
            }
        }

        // --- 2. GENERATION LOGIC ---
        function generateOutputs() {
            // Read Inputs
            let pName = document.getElementById('inp_projectName').value || "NAMA PROJEK";
            let pInfo = document.getElementById('inp_approvalInfo').value;
            let pCode = document.getElementById('inp_codeP').value;
            let valA = getNum(document.getElementById('inp_costA').value);
            let valRev = getNum(document.getElementById('inp_costRev').value);
            let lblB = document.getElementById('inp_labelB').value || "Kos PDA Asal [B]";
            let valB = getNum(document.getElementById('inp_valB').value);
            let lblD = document.getElementById('inp_labelD').value || "Kos PDA Pindaan [D]";
            let valD = getNum(document.getElementById('inp_valD').value);
            let manualText = document.getElementById('inp_manualText').value;

            // Calc Diff
            let diff = valRev - valA;
            let diffDetails = "";
            if (valA > 0 && diff !== 0) {
                let pct = ((Math.abs(diff) / valA) * 100).toFixed(2);
                let colorClass = diff > 0 ? "diff-increase" : "diff-decrease";
                let word = diff > 0 ? "Peningkatan" : "Pengurangan";
                diffDetails = `<br/><span style="font-size:0.85em; color:#555;">${word}:</span><br/><span class="${colorClass}">${fmtMoney(Math.abs(diff)).replace('RM','')}</span><span class="percentage-tag">@ ${pct}%</span>`;
            }

            // Calc Breakdown
            let valC = valA - valB;
            let valE = valD - valB;
            let valF = valE - valC;

            // --- CONDENSED TABLE ---
            let nameBlock = pName.toUpperCase() + (pCode ? ` (${pCode})` : "");
            let htmlCondensed = `
            <p class="italic text-gray-500 text-sm mb-1">Jadual Ringkas:</p>
            <table class="excel-table">
                <thead><tr><th style="width:5%">Bil</th><th style="width:50%">Nama Projek</th><th style="width:20%">Kos Asal (RM)</th><th style="width:25%">Kos Baharu (RM)</th></tr></thead>
                <tbody><tr><td class="center-col">(i)</td><td style="padding:10px"><b>${nameBlock}</b><br/>- ${pInfo}</td><td class="money-col"><b>${fmtMoney(valA).replace('RM','')}</b></td><td class="money-col"><b>${fmtMoney(valRev).replace('RM','')}</b>${diffDetails}</td></tr></tbody>
            </table>`;
            document.getElementById('master-condensed').innerHTML = htmlCondensed;

            // --- MANUAL TEXT MIDDLE SECTION ---
            let htmlManual = "";
            if(manualText.trim()) {
                 htmlManual = manualText.split('\n').map(line => `<p>${line}</p>`).join('');
            }
            document.getElementById('master-manual-text').innerHTML = htmlManual;

            // --- BREAKDOWN TABLE ---
            let htmlBreakdown = `
            <p class="italic text-gray-500 text-sm mb-1">Jadual Perincian:</p>
            <table class="excel-table">
                <thead><tr><th style="width:5%">Bil.</th><th>Perkara</th><th style="width:20%">JUMLAH (RM)</th><th style="width:20%">BAKI (RM)</th></tr></thead>
                <tbody>
                    <tr><td class="center-col">A</td><td>Kos yang diluluskan</td><td class="money-col">${fmtMoney(valA).replace('RM','')}</td><td></td></tr>
                    <tr><td class="center-col">B</td><td>${lblB}</td><td class="money-col">${fmtMoney(valB).replace('RM','')}</td><td></td></tr>
                    <tr><td class="center-col">C</td><td>Baki kos [C=A-B]</td><td></td><td class="money-col">${fmtMoney(valC).replace('RM','')}</td></tr>
                    <tr><td class="center-col">D</td><td>${lblD}</td><td class="money-col">${fmtMoney(valD).replace('RM','')}</td><td></td></tr>
                    <tr><td class="center-col">E</td><td>Peningkatan Harga [E=D-B]</td><td></td><td class="money-col">${fmtMoney(valE).replace('RM','')}</td></tr>
                    <tr class="highlight-row"><td></td><td>KOS TAMBAHAN DIPERLUKAN [F=E-C]</td><td></td><td class="money-col">${fmtMoney(valF).replace('RM','')}</td></tr>
                </tbody>
            </table>`;
            document.getElementById('master-breakdown').innerHTML = htmlBreakdown;

            // --- CLOSING SENTENCE ---
            let tcTitle = pName.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            let mainSent = "";
            if (diff > 0) mainSent = `Bahagian ini tiada halangan dengan pertambahan kos Projek ${tcTitle} sebanyak ${fmtMoney(diff)} dengan menjadikan kos projek baharu berjumlah ${fmtMoney(valRev)}.`;
            else if (diff < 0) mainSent = `Bahagian ini tiada halangan dengan pengurangan kos Projek ${tcTitle} sebanyak ${fmtMoney(Math.abs(diff))} dengan menjadikan kos projek baharu berjumlah ${fmtMoney(valRev)}.`;
            else mainSent = `Bahagian ini tiada halangan untuk meneruskan butiran Projek ${tcTitle} berdasarkan kos sedia ada berjumlah ${fmtMoney(valRev)}.`;

            let htmlClosing = `
            <p>Dengan mengambil kira ulasan di perkara XX dan hasil semakan dokumen berkaitan. ${mainSent} Walau bagaimanapun, kaedah untuk menampung peningkatan kos ini adalah berdasarkan pertimbangan pihak tuan.</p>
            <p>Ulasan Bahagian ini adalah berdasarkan kepada maklumat yang diterima sahaja dan pihak Kementerian adalah bertanggungjawab sepenuhnya dalam mematuhi peraturan semasa Kerajaan yang berkuat kuasa.</p>
            <p>Sekian ulasan Bahagian ini dan dikembalikan semula untuk pertimbangan pihak tuan selanjutnya.</p>
            <p>Sekian, terima kasih.</p>
            <p><b>‚ÄúMALAYSIA MADANI‚Äù</b></p>
            <p><b>‚ÄúBERKHIDMAT UNTUK NEGARA‚Äù</b></p>
            <p style="margin-top: 2em;">Saya yang menjalankan amanah,</p>
            <p style="margin-top: 2em;"><b>(Ir. Ts. ANITA BINTI MOHAMED SHAFIE)</b></p>`;
            document.getElementById('master-closing').innerHTML = htmlClosing;
        }

        // --- 3. NOC LOGIC ---
        function handleNocInput() {
            const text = document.getElementById('nocInput').value;
            if(!text.trim()) return;
            document.getElementById('noc-status').innerText = "Data diproses...";
            
            const stopRegex = /(NOC-ID|TARIKH\s*SURAT|TARIKH\s*PERMOHONAN|NAMA\s*KEMENTERIAN)/i;
            let lines = text.split('\n');
            let titleLines = [];
            for(let l of lines) { if(l.trim() && stopRegex.test(l)) break; if(l.trim()) titleLines.push(l.trim()); }
            let pTitle = titleLines.join(' ');

            let rawText = text.toUpperCase();
            const getVal = (k) => { let r = new RegExp(k + "\\s*([\\w\\/\\-\\.\\(\\)]+)", 'i'); let m = rawText.match(r); return m ? m[1] : "N/A"; };
            let kemMatch = text.match(/NAMA KEMENTERIAN\s*([\w\s\/\.\(\)\-]+?)\s*(?:BAHAGIAN|LAMPIRAN|$)/i);
            let ministry = kemMatch ? kemMatch[1].trim() : "N/A";
            let ruj = getVal("NO. RUJUKAN SURAT");
            const fmtDate = (d) => {
                if(!d || d.length < 5) return d;
                let [dd,mm,yy] = d.split('-');
                const map = {'JAN':'Januari','FEB':'Februari','MAR':'Mac','APR':'April','MAY':'Mei','JUN':'Jun','JUL':'Julai','AUG':'Ogos','SEP':'September','OCT':'Oktober','NOV':'November','DEC':'Disember'};
                return `${dd} ${map[mm]||mm} ${yy}`;
            };
            let dtSurat = fmtDate(getVal("TARIKH SURAT"));
            let dtPermohonan = fmtDate(getVal("TARIKH PERMOHONAN"));
            let dtEmail = fmtDate(getVal("TARIKH DITERIMA") !== "N/A" ? getVal("TARIKH DITERIMA") : getVal("TARIKH PERMOHONAN"));

            let variation = "skop, komponen, output dan tempoh";
            if(pTitle.toUpperCase().includes("KOS")) variation = "kos";
            let intro = variation === "kos" ? `Sebagaimana tuan/puan sedia maklum, NOC bagi ${variation} adalah seperti berikut:` : "Sebagaimana tuan/puan sedia maklum, butiran NOC adalah seperti berikut:";

            let nocHTML = `
                <p>Tuan/Puan,</p>
                <p><b>${pTitle}</b></p>
                <p>Dengan hormatnya merujuk kepada perkara di atas, sistem INOC bertarikh ${dtPermohonan}, surat ${ministry} dengan No. rujukan: ${ruj} bertarikh ${dtSurat} dan e-mel bertarikh ${dtEmail} adalah berkaitan.</p>
                <p>${intro}</p>
            `;
            const masterNoc = document.getElementById('master-noc');
            masterNoc.innerHTML = nocHTML;
            masterNoc.className = "mb-8 text-black not-italic"; 
            document.getElementById('noc-status').innerText = "Selesai!";
        }

        function downloadWord() {
            const content = document.getElementById('masterMemoContainer').innerHTML;
            const projectName = document.getElementById('inp_projectName').value || "Dokumen_NOC";
            const filename = projectName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30) + ".doc";

            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                "xmlns='http://www.w3.org/TR/REC-html40'>" +
                "<head><meta charset='utf-8'><title>Export HTML to Word Document</title>" +
                "<style>" +
                "@page { size: A4; margin: 2.54cm; }" + 
                "body { font-family: 'Arial', sans-serif; font-size: 11pt; text-align: justify; line-height: 1.0; }" + 
                "table { width: 100%; border-collapse: collapse; border-spacing: 0; margin-bottom: 15px; }" +
                "th, td { border: 1px solid black; padding: 2px 4px; font-size: 10pt; vertical-align: top; line-height: 1.0; mso-line-height-rule: exactly; }" + 
                "p { margin: 0; padding: 0; margin-bottom: 1em; }" + 
                ".table-container { margin-bottom: 1em; }" +
                "th { background-color: #f0f0f0; text-align: center; font-weight: bold; }" +
                ".money-col { text-align: right; white-space: nowrap; font-weight: bold; }" +
                ".center-col { text-align: center; }" +
                ".diff-increase { color: red; font-weight: bold; }" +
                ".diff-decrease { color: green; font-weight: bold; }" +
                "</style></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + content + footer;

            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = filename;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        function saveData() {
            const ids = ['nocInput','inputText','inp_projectName','inp_codeP','inp_approvalInfo','inp_costA','inp_costAdd','inp_costRev','inp_labelB','inp_valB','inp_labelD','inp_valD','inp_manualText'];
            let d = {}; ids.forEach(id => d[id] = document.getElementById(id).value);
            let blob = new Blob([JSON.stringify(d)], {type:'application/json'});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a'); a.href=url; a.download='data_projek.json'; a.click();
        }
        function loadData(input) {
            let r = new FileReader();
            r.onload = e => {
                let d = JSON.parse(e.target.result);
                for(let k in d) { if(document.getElementById(k)) document.getElementById(k).value = d[k]; }
                generateOutputs(); handleNocInput();
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
